<!DOCTYPE html>
<html lang="en">
<head>
        <title>Django : Create a QuerySet from a list, preserving order</title>
        <meta charset="utf-8" />
        <link rel="stylesheet" href="http://blog.mathieu-leplatre.info/theme/css/main.css" type="text/css" />
        <link href="http://blog.mathieu-leplatre.info/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Mathieu Leplatre Atom Feed" />

        <!--[if IE]>
                <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

        <!--[if lte IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="http://blog.mathieu-leplatre.info/css/ie.css"/>
                <script src="http://blog.mathieu-leplatre.info/js/IE8.js" type="text/javascript"></script><![endif]-->

        <!--[if lt IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="http://blog.mathieu-leplatre.info/css/ie6.css"/><![endif]-->

</head>

<body id="index" class="home">
<a href="https://github.com/leplatrem">
<img style="position: absolute; top: 0; right: 0; border: 0;" src="http://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png" alt="Fork me on GitHub" />
</a>
        <header id="banner" class="body">
                <h1><a href="http://blog.mathieu-leplatre.info/">Mathieu Leplatre </a></h1>
                <nav><ul>
                    <li><a href="http://blog.mathieu-leplatre.info/pages/about.html">About</a></li>
                    <li class="active"><a href="http://blog.mathieu-leplatre.info/category/dev.html">Dev</a></li>
                    <li ><a href="http://blog.mathieu-leplatre.info/category/personal.html">Personal</a></li>
                    <li ><a href="http://blog.mathieu-leplatre.info/category/sys.html">Sys</a></li>
                    <li ><a href="http://blog.mathieu-leplatre.info/category/ux.html">Ux</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="http://blog.mathieu-leplatre.info/django-create-a-queryset-from-a-list-preserving-order.html" rel="bookmark"
           title="Permalink to Django : Create a QuerySet from a list, preserving order">Django : Create a QuerySet from a list, preserving order</a></h1>
<a href="http://twitter.com/share" class="twitter-share-button" data-count="horizontal" data-via="leplatrem">Tweet</a><script type="text/javascript" src="http://platform.twitter.com/widgets.js"></script>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2013-11-08T00:00:00+01:00">
                Fri 08 November 2013
        </abbr>

        <address class="vcard author">
                By <a class="url fn" href="http://blog.mathieu-leplatre.info/author/mathieu-leplatre.html">Mathieu Leplatre</a>
        </address>
<p>In <a href="http://blog.mathieu-leplatre.info/category/dev.html">Dev</a>. </p>
<p>tags: <a href="http://blog.mathieu-leplatre.info/tag/django.html">django</a></p>
</footer><!-- /.post-info -->      <p>I thought it would be an easy one, but found myself lost with 34 opened tabs
on <em>stackoverflow</em>...</p>
<div class="section" id="the-problem-keep-it-ordered">
<h2>The problem : keep it ordered</h2>
<p>Usually, obtaining a <tt class="docutils literal">QuerySet</tt> from a list is quite simple :</p>
<div class="highlight"><pre>&gt;&gt;&gt; <span class="nv">queryset</span> <span class="o">=</span> Theme.objects.filter<span class="o">(</span><span class="nv">pk__in</span><span class="o">=[</span>1, 2, 10<span class="o">])</span>
&gt;&gt;&gt; <span class="nb">type</span><span class="o">(</span>queryset<span class="o">)</span>
&lt;class <span class="s1">&#39;django.db.models.query.QuerySet&#39;</span>&gt;
&gt;&gt;&gt; queryset
<span class="o">[</span>&lt;Theme: Fauna&gt;, &lt;Theme: Flora&gt;, &lt;Theme: Refuge&gt;<span class="o">]</span>
</pre></div>
<p>The problem is that the list order is ignored :</p>
<div class="highlight"><pre>&gt;&gt;&gt; Theme.objects.filter<span class="o">(</span><span class="nv">pk__in</span><span class="o">=[</span>10, 2, 1<span class="o">])</span>
<span class="o">[</span>&lt;Theme: Fauna&gt;, &lt;Theme: Flora&gt;, &lt;Theme: Refuge&gt;<span class="o">]</span>
</pre></div>
<p>If obtaining a <tt class="docutils literal">QuerySet</tt> is not a requirement, it's <a class="reference external" href="http://stackoverflow.com/a/7361598/141895">rather easy to get a list sorted</a>
according to another :</p>
<div class="highlight"><pre><span class="n">pks_list</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
<span class="n">themes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">Theme</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pk__in</span><span class="o">=</span><span class="n">pks_list</span><span class="p">))</span>
<span class="n">themes</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">pks_list</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">pk</span><span class="p">))</span>
</pre></div>
<p>In my case, I want a <tt class="docutils literal">QuerySet</tt>, a brave lazy one, with proper <tt class="docutils literal">filter()</tt>,
<tt class="docutils literal">exclude()</tt>, <tt class="docutils literal">values()</tt> ...</p>
</div>
<div class="section" id="fallback-to-sql">
<h2>Fallback to SQL</h2>
<p>AFAIK, most database engines ignore order of records, until you specify an
ordering column. In our case, the list is arbitrary, and does not map to any
existing attribute, thus db column.</p>
<p>If you use MySQL (<em>who does?!</em>), there is a <tt class="docutils literal">FIELD()</tt> function that provides
<a class="reference external" href="http://stackoverflow.com/a/3626200/141895">custom input for the sort method</a> :</p>
<div class="highlight"><pre><span class="k">SELECT</span> <span class="o">*</span>
<span class="k">FROM</span> <span class="n">theme</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="n">FIELD</span><span class="p">(</span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</pre></div>
<p>Using the ORM, it gives us (<em>thanks Daniel Roseman</em>)</p>
<div class="highlight"><pre><span class="n">pk_list</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
<span class="n">ordering</span> <span class="o">=</span> <span class="s">&#39;FIELD(`id`, </span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="s">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span> <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">pk_list</span><span class="p">)</span>
<span class="n">queryset</span> <span class="o">=</span> <span class="n">Theme</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pk__in</span><span class="o">=</span><span class="p">[</span><span class="n">pk_list</span><span class="p">])</span><span class="o">.</span><span class="n">extra</span><span class="p">(</span>
           <span class="n">select</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;ordering&#39;</span><span class="p">:</span> <span class="n">ordering</span><span class="p">},</span> <span class="n">order_by</span><span class="o">=</span><span class="p">(</span><span class="s">&#39;ordering&#39;</span><span class="p">,))</span>
</pre></div>
<p>Well, good news it can be <a class="reference external" href="http://stackoverflow.com/questions/1309624/simulating-mysqls-order-by-field-in-postgresql">ported to PostgreSQL</a>.
But if possible, I would prefer native SQL.</p>
<p>And it looks like the magnificient syntax of SQL provides <tt class="docutils literal">ORDER BY CASE WHEN ... END</tt> !</p>
<div class="highlight"><pre><span class="k">SELECT</span> <span class="o">*</span>
<span class="k">FROM</span> <span class="n">theme</span>
<span class="k">ORDER</span> <span class="k">BY</span>
  <span class="k">CASE</span>
    <span class="k">WHEN</span> <span class="n">id</span><span class="o">=</span><span class="mi">10</span> <span class="k">THEN</span> <span class="mi">0</span>
    <span class="k">WHEN</span> <span class="n">id</span><span class="o">=</span><span class="mi">2</span> <span class="k">THEN</span> <span class="mi">1</span>
    <span class="k">WHEN</span> <span class="n">id</span><span class="o">=</span><span class="mi">1</span> <span class="k">THEN</span> <span class="mi">2</span>
  <span class="k">END</span><span class="p">;</span>
</pre></div>
<p>Using the ORM, it gives us :</p>
<div class="highlight"><pre><span class="n">pk_list</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
<span class="n">clauses</span> <span class="o">=</span> <span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s">&#39;WHEN id=</span><span class="si">%s</span><span class="s"> THEN </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pk</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">pk</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pk_list</span><span class="p">)])</span>
<span class="n">ordering</span> <span class="o">=</span> <span class="s">&#39;CASE </span><span class="si">%s</span><span class="s"> END&#39;</span> <span class="o">%</span> <span class="n">clauses</span>
<span class="n">queryset</span> <span class="o">=</span> <span class="n">Theme</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pk__in</span><span class="o">=</span><span class="n">pk_list</span><span class="p">)</span><span class="o">.</span><span class="n">extra</span><span class="p">(</span>
           <span class="n">select</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;ordering&#39;</span><span class="p">:</span> <span class="n">ordering</span><span class="p">},</span> <span class="n">order_by</span><span class="o">=</span><span class="p">(</span><span class="s">&#39;ordering&#39;</span><span class="p">,))</span>
</pre></div>
<p>I wonder how it behaves with zillions of records though ;)</p>
<p>One more thing: before Django 1.6, there <a class="reference external" href="https://code.djangoproject.com/ticket/14930">was a bug</a> with calling <tt class="docutils literal">values_list()</tt>
on a queryset ordered by an extra column. Use this :</p>
<div class="highlight"><pre><span class="n">values</span> <span class="o">=</span> <span class="n">queryset</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s">&#39;ordering&#39;</span><span class="p">,</span> <span class="s">&#39;label&#39;</span><span class="p">)</span>
<span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">value</span><span class="p">[</span><span class="s">&#39;label&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span><span class="p">]</span>
</pre></div>
<p>Good luck ! Please share your advices or critics ;)</p>
</div>

    </div><!-- /.entry-content -->
    <div class="comments">
      <h2>Comments !</h2>
      <div id="disqus_thread"></div>
      <script type="text/javascript">
        var disqus_identifier = "django-create-a-queryset-from-a-list-preserving-order.html";
        (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://mathieuleplatre.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
      </script>
    </div>

  </article>
</section>
        <section id="extras" class="body">
                <div class="social">
                        <h2>social</h2>
                        <ul>
                            <li><a href="http://blog.mathieu-leplatre.info/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>

                            <li><a href="http://www.linkedin.com/in/leplatre">LinkedIn</a></li>
                            <li><a href="https://code.launchpad.net/~mathieu.leplatre">Launchpad</a></li>
                            <li><a href="https://github.com/leplatrem">GitHub</a></li>
                            <li><a href="https://plus.google.com/u/0/106965745149150173373">Google+</a></li>
                            <li><a href="http://twitter.com/leplatrem">Twitter</a></li>
                            <li><a href="http://identi.ca/leplatrem">Identi.ca</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

    <script type="text/javascript">
        var pkBaseURL = (("https:" == document.location.protocol) ? "https://mathieu-leplatre.info/piwik/" : "http://mathieu-leplatre.info/piwik/");
    document.write(unescape("%3Cscript src='" + pkBaseURL + "piwik.js' type='text/javascript'%3E%3C/script%3E"));
    </script><script type="text/javascript">
    try {
    var piwikTracker = Piwik.getTracker(pkBaseURL + "piwik.php", 1);
    piwikTracker.trackPageView();
    piwikTracker.enableLinkTracking();
    } catch( err ) {}
    </script><noscript><p><img src="http://mathieu-leplatre.info/piwik/piwik.php?idsite=1" style="border:0" alt="" /></p></noscript>
<script type="text/javascript">
    var disqus_shortname = 'mathieuleplatre';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
</body>
</html>