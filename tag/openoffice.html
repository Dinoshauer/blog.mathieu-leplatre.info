<!DOCTYPE html>
<html lang="en">
<head>
        <title>Mathieu Leplatre - openoffice</title>
        <meta charset="utf-8" />
        <link rel="stylesheet" href="http://blog.mathieu-leplatre.info/theme/css/main.css" type="text/css" />
        <link href="http://blog.mathieu-leplatre.info/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Mathieu Leplatre Atom Feed" />

        <!--[if IE]>
                <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

        <!--[if lte IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="http://blog.mathieu-leplatre.info/css/ie.css"/>
                <script src="http://blog.mathieu-leplatre.info/js/IE8.js" type="text/javascript"></script><![endif]-->

        <!--[if lt IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="http://blog.mathieu-leplatre.info/css/ie6.css"/><![endif]-->

</head>

<body id="index" class="home">
<a href="https://github.com/leplatrem">
<img style="position: absolute; top: 0; right: 0; border: 0;" src="http://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png" alt="Fork me on GitHub" />
</a>
        <header id="banner" class="body">
                <h1><a href="http://blog.mathieu-leplatre.info/">Mathieu Leplatre </a></h1>
                <nav><ul>
                    <li><a href="http://blog.mathieu-leplatre.info/pages/about.html">About</a></li>
                    <li ><a href="http://blog.mathieu-leplatre.info/category/dev.html">Dev</a></li>
                    <li ><a href="http://blog.mathieu-leplatre.info/category/personal.html">Personal</a></li>
                    <li ><a href="http://blog.mathieu-leplatre.info/category/sys.html">Sys</a></li>
                    <li ><a href="http://blog.mathieu-leplatre.info/category/ux.html">Ux</a></li>
                </ul></nav>
        </header><!-- /#banner -->
        
        

            <aside id="featured" class="body">
                <article>
                    <h1 class="entry-title"><a href="http://blog.mathieu-leplatre.info/generate-office-documents-with-django.html">Generate office documents with Django</a></h1> 
<footer class="post-info">
        <abbr class="published" title="2013-09-13T00:00:00+02:00">
                Fri 13 September 2013
        </abbr>

        <address class="vcard author">
                By <a class="url fn" href="http://blog.mathieu-leplatre.info/author/mathieu-leplatre.html">Mathieu Leplatre</a>
        </address>
<p>In <a href="http://blog.mathieu-leplatre.info/category/dev.html">Dev</a>. </p>
<p>tags: <a href="http://blog.mathieu-leplatre.info/tag/django.html">django</a><a href="http://blog.mathieu-leplatre.info/tag/openoffice.html">openoffice</a><a href="http://blog.mathieu-leplatre.info/tag/convertit.html">convertit</a><a href="http://blog.mathieu-leplatre.info/tag/appypod.html">appypod</a></p>
</footer><!-- /.post-info --><p>In our recent Django projects, we had to create documents (Libre/OpenOffice, Microsoft Office, PDF...),
and therefore created two components :</p>
<ul class="simple">
<li><a class="reference external" href="https://github.com/makinacorpus/django-appypod">django-appypod</a>, providing document templates views, built on top of <a class="reference external" href="http://appyframework.org/pod.html">Appy.pod</a> ;</li>
<li><a class="reference external" href="https://github.com/makinacorpus/convertit">convertit</a>, a generic format conversion Web API.</li>
</ul>
<div class="section" id="id1">
<h2>django-appypod</h2>
<p><em>Appy</em> is a set of python tools (e.g. framework) by <a class="reference external" href="https://launchpad.net/~gaetan-delannay">Gaetan Delannay</a>, which provides, among other stuff,
a templating engine for OpenDocument files.</p>
<p>One the great advantage is that you edit your templates in LibreOffice, <a class="reference external" href="http://en.wikipedia.org/wiki/WYSIWYG">WYSIWYG</a> !</p>
<img alt="" class="align-center" src="/images/appypod-template.png" style="width: 70%;" />
<p><em>django-appypod</em> is a template view that renders a OpenDocument template for a context.
The exact same way you already do for HTML.</p>
<p>Using class-based generic views :</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">django.view.generic.detail</span> <span class="kn">import</span> <span class="n">TemplateView</span>

<span class="kn">from</span> <span class="nn">djappypod.response</span> <span class="kn">import</span> <span class="n">OdtTemplateResponse</span>


<span class="k">class</span> <span class="nc">YourDocument</span><span class="p">(</span><span class="n">TemplateView</span><span class="p">):</span>
    <span class="n">response_class</span> <span class="o">=</span> <span class="n">OdtTemplateResponse</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s">&quot;your/template.odt&quot;</span>

    <span class="k">def</span> <span class="nf">get_context_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;title&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;Simple as hello ;)&#39;</span>
        <span class="k">return</span> <span class="n">kwargs</span>
</pre></div>
<p>Using classic functions-based views :</p>
<div class="highlight"><pre><span class="k">def</span> <span class="nf">your_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;title&#39;</span><span class="p">:</span> <span class="s">&#39;Simple as hello ;)&#39;</span>
    <span class="p">}</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">OdtTemplateResponse</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">&quot;your/template.odt&quot;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
    <span class="n">response</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">response</span>
</pre></div>
<img alt="" class="align-center" src="/images/appypod-rendered.png" style="width: 70%;" />
</div>
<div class="section" id="id2">
<h2>ConvertIt</h2>
<p>We often need to serve those document as PDF files, and some users can't
be satisfied with <em>OpenDocument</em> files.</p>
<p><em>Appy</em> can rely on OpenOffice to convert documents to PDF and MS-Word, but we didn't like
the idea of having to install the bunch of binaries along every Django project.
Therefore we created <em>ConvertIt</em>, a Web API that will just be in charge of
format conversion. It can live on a dedicated server, and thus isolate binaries, and
potentially convert from and to any exotic formats, relying on any exotic system binaries.</p>
<p>So far we implemented most office documents conversions (.pdf, .doc, .xls), as well as SVG to PDF and PNG.</p>
<div class="section" id="docker-image">
<h3>Docker image</h3>
<p>If you use Docker, you can get a ConvertIt instance running in one command :</p>
<pre class="literal-block">
sudo docker run -p :6543 makinacorpus/convertit
</pre>
</div>
<div class="section" id="manual-installation">
<h3>Manual installation</h3>
<p>It is a Pyramid project, pretty straightforward :</p>
<div class="highlight"><pre>pip install convertit
</pre></div>
<p>Plus some conversion binaries (each one is optional):</p>
<div class="highlight"><pre>sudo apt-get install -y libreoffice unoconv inkscape
</pre></div>
<p>To run a development instance :</p>
<div class="highlight"><pre>pserve development.ini --reload
</pre></div>
<p>To run a production instance :</p>
<div class="highlight"><pre>pip install gunicorn
gunicorn --paste production.ini
</pre></div>
</div>
<div class="section" id="usage">
<h3>Usage</h3>
<p>Using GET requests :</p>
<pre class="literal-block">
curl http://convertit/?url=http://server/document.odt&amp;to=application/pdf
HTTP/1.1 302 Found
Content-Disposition: attachement; filename=document.pdf
...
</pre>
<p>Uploading file with POST :</p>
<pre class="literal-block">
curl -F &quot;file=&#64;tiger.svg&quot; http://convertit/?to=image/png
HTTP/1.1 302 Found
Content-Disposition: attachement; filename=tiger.png
...
</pre>
</div>
<div class="section" id="integration-with-django">
<h3>Integration with Django</h3>
<p>If your documents do not require login, a simple and stupid template tag can do it :</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">django.conf</span> <span class="kn">import</span> <span class="n">settings</span>
<span class="kn">from</span> <span class="nn">django</span> <span class="kn">import</span> <span class="n">template</span>
<span class="kn">from</span> <span class="nn">django.core.urlresolvers</span> <span class="kn">import</span> <span class="n">reverse</span><span class="p">,</span> <span class="n">NoReverseMatch</span>


<span class="n">register</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">Library</span><span class="p">()</span>


<span class="nd">@register.simple_tag</span>
<span class="k">def</span> <span class="nf">convert_url</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">sourceurl</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">format</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;format&#39;</span><span class="p">,</span> <span class="s">&#39;application/pdf&#39;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">sourceurl</span> <span class="o">=</span> <span class="n">reverse</span><span class="p">(</span><span class="n">sourceurl</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">NoReverseMatch</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="n">fullurl</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">build_absolute_uri</span><span class="p">(</span><span class="n">sourceurl</span><span class="p">)</span>
    <span class="k">return</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">?url=</span><span class="si">%s</span><span class="s">&amp;to=</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">CONVERSION_SERVER</span><span class="p">,</span>
                                <span class="n">urllib</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="n">fullurl</span><span class="p">),</span>
                                <span class="n">urllib</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="n">format</span><span class="p">))</span>
</pre></div>
<p>Which you then use in templates:</p>
<pre class="literal-block">
&lt;a href=&quot;{% convert_url &quot;app:document&quot; object.pk %}&quot;&gt;Download PDF version&lt;/a&gt;
</pre>
<p>However, if your view requires authentication, there are several strategies:</p>
<ul class="simple">
<li>Auto-login requests coming from ConvertIt server ;</li>
<li>Add a login required proxy view that download the file and perform a POST query to ConvertIt ;</li>
<li>Setup SSO or any other token mechanism ;</li>
<li>Contribute to ConvertIt to add HTTP authentication (<tt class="docutils literal"><span class="pre">url=http://user:pass&#64;host</span></tt>) ;</li>
</ul>
<p><a class="reference external" href="https://gist.github.com/leplatrem/6552003">I made a snippet</a> for the first option</p>
</div>
</div>
<div class="section" id="in-short">
<h2>In short...</h2>
<ul class="simple">
<li><em>django-appypod</em> is great because templates are WYSIWYG ;</li>
<li><em>ConvertIt</em> is great because it's generic and pluggable ;</li>
<li>There are great together because their deliver both office and PDF formats ;</li>
</ul>
<p>There are alternatives though if PDF is enough for you :</p>
<ul class="simple">
<li><a class="reference external" href="http://weasyprint.org">WeasyPrint</a></li>
<li><a class="reference external" href="http://www.xhtml2pdf.com/">xhtml2pdf</a></li>
</ul>
</div>
<p>There are <a href="http://blog.mathieu-leplatre.info/generate-office-documents-with-django.html#disqus_thread">comments</a>.</p>                </article>
<p class="paginator">
    Page 1 / 1
</p>
            </aside><!-- /#featured -->
            </ol><!-- /#posts-list -->
            </section><!-- /#content -->
        <section id="extras" class="body">
                <div class="social">
                        <h2>social</h2>
                        <ul>
                            <li><a href="http://blog.mathieu-leplatre.info/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>

                            <li><a href="http://www.linkedin.com/in/leplatre">LinkedIn</a></li>
                            <li><a href="https://code.launchpad.net/~mathieu.leplatre">Launchpad</a></li>
                            <li><a href="https://github.com/leplatrem">GitHub</a></li>
                            <li><a href="https://plus.google.com/u/0/106965745149150173373">Google+</a></li>
                            <li><a href="http://twitter.com/leplatrem">Twitter</a></li>
                            <li><a href="http://identi.ca/leplatrem">Identi.ca</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

    <script type="text/javascript">
        var pkBaseURL = (("https:" == document.location.protocol) ? "https://mathieu-leplatre.info/piwik/" : "http://mathieu-leplatre.info/piwik/");
    document.write(unescape("%3Cscript src='" + pkBaseURL + "piwik.js' type='text/javascript'%3E%3C/script%3E"));
    </script><script type="text/javascript">
    try {
    var piwikTracker = Piwik.getTracker(pkBaseURL + "piwik.php", 1);
    piwikTracker.trackPageView();
    piwikTracker.enableLinkTracking();
    } catch( err ) {}
    </script><noscript><p><img src="http://mathieu-leplatre.info/piwik/piwik.php?idsite=1" style="border:0" alt="" /></p></noscript>
<script type="text/javascript">
    var disqus_shortname = 'mathieuleplatre';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
</body>
</html>