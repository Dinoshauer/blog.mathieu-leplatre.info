<!DOCTYPE html>
<html lang="en">
<head>
        <title>Mathieu Leplatre - continuous integration</title>
        <meta charset="utf-8" />
        <link rel="stylesheet" href="http://blog.mathieu-leplatre.info/theme/css/main.css" type="text/css" />
        <link href="http://blog.mathieu-leplatre.info/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Mathieu Leplatre Atom Feed" />

        <!--[if IE]>
                <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

        <!--[if lte IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="http://blog.mathieu-leplatre.info/css/ie.css"/>
                <script src="http://blog.mathieu-leplatre.info/js/IE8.js" type="text/javascript"></script><![endif]-->

        <!--[if lt IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="http://blog.mathieu-leplatre.info/css/ie6.css"/><![endif]-->

</head>

<body id="index" class="home">
<a href="https://github.com/leplatrem">
<img style="position: absolute; top: 0; right: 0; border: 0;" src="http://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png" alt="Fork me on GitHub" />
</a>
        <header id="banner" class="body">
                <h1><a href="http://blog.mathieu-leplatre.info/">Mathieu Leplatre </a></h1>
                <nav><ul>
                    <li><a href="http://blog.mathieu-leplatre.info/pages/about.html">About</a></li>
                    <li ><a href="http://blog.mathieu-leplatre.info/category/dev.html">Dev</a></li>
                    <li ><a href="http://blog.mathieu-leplatre.info/category/personal.html">Personal</a></li>
                    <li ><a href="http://blog.mathieu-leplatre.info/category/sys.html">Sys</a></li>
                    <li ><a href="http://blog.mathieu-leplatre.info/category/ux.html">Ux</a></li>
                </ul></nav>
        </header><!-- /#banner -->
        
        

            <aside id="featured" class="body">
                <article>
                    <h1 class="entry-title"><a href="http://blog.mathieu-leplatre.info/django-et-jenkins-fr.html">Django et Jenkins</a></h1> 
<footer class="post-info">
        <abbr class="published" title="2011-04-28T17:25:00+02:00">
                Thu 28 April 2011
        </abbr>

        <address class="vcard author">
                By <a class="url fn" href="http://blog.mathieu-leplatre.info/author/mathieu-leplatre.html">Mathieu Leplatre</a>
        </address>
<p>In <a href="http://blog.mathieu-leplatre.info/category/dev.html">Dev</a>. </p>
<p>tags: <a href="http://blog.mathieu-leplatre.info/tag/django.html">django</a><a href="http://blog.mathieu-leplatre.info/tag/jenkins.html">jenkins</a><a href="http://blog.mathieu-leplatre.info/tag/continuous-integration.html">continuous integration</a><a href="http://blog.mathieu-leplatre.info/tag/.html"></a></p>
</footer><!-- /.post-info --><p><em>Article original publié chez</em> <a class="reference external" href="http://makina-corpus.org">Makina Corpus</a></p>
<p>Lors des <a class="reference external" href="http://rencontres.django-fr.org/2011/">Recontres Django 2011</a>, <a class="reference external" href="http://www.akei.com">Nicolas Perriault</a> a présenté les principes de l'<a class="reference external" href="http://fr.wikipedia.org/wiki/Int%C3%A9gration_continue">intégration continue</a> avec <a class="reference external" href="http://djangoproject.com">Django</a> et <a class="reference external" href="http://jenkins-ci.org/">Jenkins</a>.</p>
<p>Le diaporama, <a class="reference external" href="http://www.akei.com/presentations/2011-Djangocong/index.html">disponible en ligne</a>, suffit amplement pour démarrer !</p>
<p>Mais pour qu'un projet django soit testé facilement, il doit se déployer et se lancer facilement ! C'est certes l'occasion de peaufiner l'automatisation, mais c'est loin d'être trivial quand il y a du SIG, du <a class="reference external" href="http://celeryproject.org">celery</a> ...
Je vais tenter de partager mes notes dans ce billet.</p>
<div class="section" id="le-minimum-requis">
<h2>Le minimum requis</h2>
<p>Pour l'installation de Jenkins, rien de plus simple (<em>sur debian</em>)</p>
<pre class="literal-block">
sudo aptitude install jenkins
</pre>
<p>Mais il va falloir lui donner de quoi télécharger votre code sur <cite>git</cite> et parfois compiler les librairies python nécessaires</p>
<pre class="literal-block">
sudo aptitude install git-core
sudo aptitude install python-dev build-essential python-virtualenv
</pre>
<p>Les plugins indispensables :</p>
<ul class="simple">
<li>covertura</li>
<li>Violations</li>
<li>GIT</li>
<li>Green Balls</li>
<li>Continuous Integration Game</li>
</ul>
</div>
<div class="section" id="organisation-du-projet-django">
<h2>Organisation du projet Django</h2>
<ul>
<li><p class="first">Définition des dépendances globales dans <cite>requirements.txt</cite></p>
<pre class="literal-block">
Django&gt;=1.3
south
</pre>
</li>
<li><p class="first">Définition des dépendances liées aux tests dans <cite>requirements-testing.txt</cite></p>
<pre class="literal-block">
django-jenkins
</pre>
</li>
<li><p class="first">Ajout d'un fichier <cite>pylint.rc</cite> pour régler les niveaux d'alerte <a class="reference external" href="http://www.python.org/dev/peps/pep-0008/">PEP-8</a></p>
<pre class="literal-block">
[MESSAGES CONTROL]
disable=E1101,E1103,C0111,I0011,I0012,W0704,W0142,W0212,W0232,W0613,W0702,R0201
...
...
</pre>
</li>
<li><p class="first">Modèle de settings de tests dans <cite>project/test_settings.py</cite></p>
</li>
</ul>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">default_settings</span> <span class="kn">import</span> <span class="o">*</span>
<span class="n">DEBUG</span> <span class="o">=</span> <span class="bp">True</span>
<span class="n">TEMPLATE_DEBUG</span> <span class="o">=</span> <span class="n">DEBUG</span>

<span class="n">INSTALLED_APPS</span> <span class="o">+=</span> <span class="p">(</span>
    <span class="s">&#39;django_jenkins&#39;</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">PYLINT_RCFILE</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PROJECT_ROOT_PATH</span><span class="p">,</span> <span class="s">&#39;..&#39;</span><span class="p">,</span> <span class="s">&#39;conf&#39;</span><span class="p">,</span> <span class="s">&#39;pylint.rc&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="section" id="configuration-du-job-jenkins">
<h2>Configuration du job Jenkins</h2>
<p>Les informations de la présentation de Nicolas suffisent pour démarrer.</p>
<p>J'ai noté cependant qu'il fallait lancer <cite>manage.py</cite> depuis un répertoire parent au projet pour que l'exploration du code source fonctionne.</p>
<p>Pour profiter de la magie des ingrédients précédents, nous aurons donc juste à ajouter un bloc script shell, qui installe les dépendances listées, pose les settings de test et migre la base (avec <a class="reference external" href="http://south.aeracode.org">South</a>):</p>
<div class="highlight"><pre><span class="c">#!/bin/bash -ex</span>
virtualenv --quiet ve
<span class="nb">source</span> ./ve/bin/activate
pip install -E ./ve -r <span class="nv">$WORKSPACE</span>/requirements.txt
pip install -E ./ve -r <span class="nv">$WORKSPACE</span>/requirements-testing.txt
cp <span class="nv">$WORKSPACE</span>/project/test_settings.py <span class="nv">$WORKSPACE</span>/project/local_settings.py
python <span class="nv">$WORKSPACE</span>/project/manage.py syncdb --noinput
python <span class="nv">$WORKSPACE</span>/project/manage.py migrate
deactivate
</pre></div>
<p>et celui-ci pour lancer les tests proprements dits :</p>
<div class="highlight"><pre><span class="c">#!/bin/bash -ex</span>
virtualenv --quiet ve
<span class="nb">source</span> ./ve/bin/activate
python <span class="nv">$WORKSPACE</span>/project/manage.py jenkins yourapps
deactivate
</pre></div>
</div>
<div class="section" id="pour-un-projet-sig">
<h2>Pour un projet SIG</h2>
<p>Il faut installer certaines librairies SIG sur le serveur Jenkins.</p>
<div class="highlight"><pre>sudo aptitude install libproj0 libgeos-c1
</pre></div>
<p>Si le besoin de cloisonner ces librairies pour chaque projet se fait ressentir, il faut utiliser des outils comme <a class="reference external" href="http://www.minitage.org">minitage</a>.</p>
<div class="section" id="spatialite-au-lieu-de-postgis-comme-base-de-tests">
<h3>Spatialite au lieu de PostGIS comme base de tests</h3>
<div class="highlight"><pre>sudo aptitude install python-sqlite libspatialite2 sqlite3
</pre></div>
<p>Script d'initialisation</p>
<div class="highlight"><pre>wget http://www.gaia-gis.it/spatialite/init_spatialite-2.3.zip -O /tmp/init_spatialite-2.3.zip
<span class="nb">cd</span> /usr/local/lib/
sudo unzip /tmp/init_spatialite-2.3.zip
</pre></div>
<p>avec dans <cite>test_settings.py</cite></p>
<div class="highlight"><pre><span class="n">DATABASES</span> <span class="o">=</span> <span class="p">{</span>
<span class="s">&#39;default&#39;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s">&#39;ENGINE&#39;</span><span class="p">:</span> <span class="s">&#39;django.contrib.gis.db.backends.spatialite&#39;</span><span class="p">,</span>
    <span class="o">...</span>
    <span class="o">...</span>

<span class="n">SPATIALITE_SQL</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s">&#39;usr&#39;</span><span class="p">,</span> <span class="s">&#39;local&#39;</span><span class="p">,</span> <span class="s">&#39;lib&#39;</span><span class="p">,</span> <span class="s">&#39;init_spatialite-2.3.sql&#39;</span><span class="p">)</span>
</pre></div>
<p>Si pysqlite n'a pas été compilé avec les extensions C (Erreur: <em>The pysqlite library does not support C extension loading.</em>) il va falloir le recompiler !</p>
<div class="highlight"><pre>sudo aptitude install libsqlite3-dev
wget http://pysqlite.googlecode.com/files/pysqlite-2.6.3.tar.gz
tar -zxvf pysqlite-2.6.3.tar.gz
<span class="nb">cd </span>pysqlite-2.6.3
sed -i s/define<span class="o">=</span>SQLITE_OMIT_LOAD_EXTENSION/#define<span class="o">=</span>SQLITE_OMIT_LOAD_EXTENSION/g setup.cfg

<span class="nb">source</span> ./ve/bin/activate
python setup.py install
</pre></div>
</div>
</div>
<div class="section" id="pour-un-projet-celery">
<h2>Pour un projet Celery</h2>
<div class="section" id="kombu-au-lieu-de-rabbitmq-comme-gestionnaire-de-messages">
<h3>Kombu au lieu de RabbitMQ comme gestionnaire de messages</h3>
<p><cite>requirements-testing.txt</cite></p>
<pre class="literal-block">
kombu
djkombu
</pre>
<p><cite>test_settings.py</cite></p>
<div class="highlight"><pre><span class="n">INSTALLED_APPS</span> <span class="o">+=</span> <span class="p">(</span>
    <span class="s">&#39;djkombu&#39;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">CARROT_BACKEND</span> <span class="o">=</span> <span class="s">&quot;django&quot;</span>
</pre></div>
<p>Pour désactiver la parallélisation lors des tests</p>
<div class="highlight"><pre><span class="n">CELERY_ALWAYS_EAGER</span> <span class="o">=</span> <span class="bp">True</span>
</pre></div>
</div>
</div>
<p>There are <a href="http://blog.mathieu-leplatre.info/django-et-jenkins-fr.html#disqus_thread">comments</a>.</p>                </article>
<p class="paginator">
    Page 1 / 1
</p>
            </aside><!-- /#featured -->
            </ol><!-- /#posts-list -->
            </section><!-- /#content -->
        <section id="extras" class="body">
                <div class="social">
                        <h2>social</h2>
                        <ul>
                            <li><a href="http://blog.mathieu-leplatre.info/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>

                            <li><a href="http://www.linkedin.com/in/leplatre">LinkedIn</a></li>
                            <li><a href="https://code.launchpad.net/~mathieu.leplatre">Launchpad</a></li>
                            <li><a href="https://github.com/leplatrem">GitHub</a></li>
                            <li><a href="https://plus.google.com/u/0/106965745149150173373">Google+</a></li>
                            <li><a href="http://twitter.com/leplatrem">Twitter</a></li>
                            <li><a href="http://identi.ca/leplatrem">Identi.ca</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

    <script type="text/javascript">
        var pkBaseURL = (("https:" == document.location.protocol) ? "https://mathieu-leplatre.info/piwik/" : "http://mathieu-leplatre.info/piwik/");
    document.write(unescape("%3Cscript src='" + pkBaseURL + "piwik.js' type='text/javascript'%3E%3C/script%3E"));
    </script><script type="text/javascript">
    try {
    var piwikTracker = Piwik.getTracker(pkBaseURL + "piwik.php", 1);
    piwikTracker.trackPageView();
    piwikTracker.enableLinkTracking();
    } catch( err ) {}
    </script><noscript><p><img src="http://mathieu-leplatre.info/piwik/piwik.php?idsite=1" style="border:0" alt="" /></p></noscript>
<script type="text/javascript">
    var disqus_shortname = 'mathieuleplatre';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
</body>
</html>