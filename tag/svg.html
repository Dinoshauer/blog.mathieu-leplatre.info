<!DOCTYPE html>
<html lang="en">
<head>
        <title>Mathieu Leplatre - svg</title>
        <meta charset="utf-8" />
        <link rel="stylesheet" href="http://blog.mathieu-leplatre.info/theme/css/main.css" type="text/css" />
        <link href="http://blog.mathieu-leplatre.info/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Mathieu Leplatre Atom Feed" />

        <!--[if IE]>
                <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

        <!--[if lte IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="http://blog.mathieu-leplatre.info/css/ie.css"/>
                <script src="http://blog.mathieu-leplatre.info/js/IE8.js" type="text/javascript"></script><![endif]-->

        <!--[if lt IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="http://blog.mathieu-leplatre.info/css/ie6.css"/><![endif]-->

</head>

<body id="index" class="home">
<a href="https://github.com/leplatrem">
<img style="position: absolute; top: 0; right: 0; border: 0;" src="http://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png" alt="Fork me on GitHub" />
</a>
        <header id="banner" class="body">
                <h1><a href="http://blog.mathieu-leplatre.info/">Mathieu Leplatre </a></h1>
                <nav><ul>
                    <li><a href="http://blog.mathieu-leplatre.info/pages/about.html">About</a></li>
                    <li ><a href="http://blog.mathieu-leplatre.info/category/dev.html">Dev</a></li>
                    <li ><a href="http://blog.mathieu-leplatre.info/category/personal.html">Personal</a></li>
                    <li ><a href="http://blog.mathieu-leplatre.info/category/sys.html">Sys</a></li>
                    <li ><a href="http://blog.mathieu-leplatre.info/category/ux.html">Ux</a></li>
                </ul></nav>
        </header><!-- /#banner -->
        
        

            <aside id="featured" class="body">
                <article>
                    <h1 class="entry-title"><a href="http://blog.mathieu-leplatre.info/static-build-of-cairo-and-librsvg.html">Static build of Cairo and librsvg</a></h1> 
<footer class="post-info">
        <abbr class="published" title="2008-07-01T11:25:00+02:00">
                Tue 01 July 2008
        </abbr>

        <address class="vcard author">
                By <a class="url fn" href="http://blog.mathieu-leplatre.info/author/mathieu-leplatre.html">Mathieu Leplatre</a>
        </address>
<p>In <a href="http://blog.mathieu-leplatre.info/category/dev.html">Dev</a>. </p>
<p>tags: <a href="http://blog.mathieu-leplatre.info/tag/cairo.html">cairo</a><a href="http://blog.mathieu-leplatre.info/tag/svg.html">svg</a><a href="http://blog.mathieu-leplatre.info/tag/c.html">C</a></p>
</footer><!-- /.post-info --><img alt="" src="/images/unicode.png" />
<div class="section" id="why">
<h2>Why ?</h2>
<ul class="simple">
<li>Convert SVG files to PDF or PNG, with full Unicode support (right-to-left languages), transparency, gradients, PDF image compression, ...</li>
<li>Cairo and librsvg are the best in town.</li>
<li>Cairo and librsvg are very modern libraries which became famous only in the past 3 years. Thus, GNU/Linux distributions do not always have recent versions and full capabilities.</li>
<li>A <cite>static build</cite> does all the bindings to libraries at compile time, which hence removes specific versions dependencies. <em>(this method has many drawbacks but can help sometimes)</em></li>
</ul>
</div>
<div class="section" id="the-program-svgconvert-c">
<h2>The program : svgconvert.c</h2>
<blockquote>
<ul class="simple">
<li>This program is a merge of Carl Worth's <a class="reference external" href="http://cgit.freedesktop.org/~cworth/svg2pdf/">svg2pdf</a> and <a class="reference external" href="http://cgit.freedesktop.org/~cworth/svg2png/">svg2png</a></li>
</ul>
</blockquote>
<div class="highlight"><pre><span class="cm">/*</span>
<span class="cm">* Copyright © 2005 Red Hat, Inc.</span>
<span class="cm">* Copyright © 2006 Red Hat, Inc.</span>
<span class="cm">* Copyright © 2007 Red Hat, Inc.</span>
<span class="cm">*</span>
<span class="cm">* Permission is hereby granted, free of charge, to any person</span>
<span class="cm">* obtaining a copy of this software and associated documentation</span>
<span class="cm">* files (the &quot;Software&quot;), to deal in the Software without</span>
<span class="cm">* restriction, including without limitation the rights to use, copy,</span>
<span class="cm">* modify, merge, publish, distribute, sublicense, and/or sell copies</span>
<span class="cm">* of the Software, and to permit persons to whom the Software is</span>
<span class="cm">* furnished to do so, subject to the following conditions:</span>
<span class="cm">*</span>
<span class="cm">* The above copyright notice and this permission notice shall be</span>
<span class="cm">* included in all copies or substantial portions of the Software.</span>
<span class="cm">*</span>
<span class="cm">* THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND,</span>
<span class="cm">* EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF</span>
<span class="cm">* MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND</span>
<span class="cm">* NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS</span>
<span class="cm">* BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN</span>
<span class="cm">* ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN</span>
<span class="cm">* CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE</span>
<span class="cm">* SOFTWARE.</span>
<span class="cm">*</span>
<span class="cm">* Authors: Kristian Høgsberg &lt;krh@redhat.com&gt;</span>
<span class="cm">* Carl Worth &lt;cworth@redhat.com&gt;</span>
<span class="cm">* Behdad Esfahbod &lt;besfahbo@redhat.com&gt;</span>
<span class="cm">* Mathieu Leplatre &lt;contact@mathieu-leplatre.info&gt;</span>
<span class="cm">*/</span>

<span class="cp">#include &lt;stdio.h&gt;</span>
<span class="cp">#include &lt;stdlib.h&gt;</span>
<span class="cp">#include &lt;glib/gprintf.h&gt;</span>
<span class="cp">#include &lt;librsvg/rsvg.h&gt;</span>
<span class="cp">#include &lt;librsvg/rsvg-cairo.h&gt;</span>

<span class="cp">#include &lt;cairo-pdf.h&gt;</span>

<span class="cp">#define FAIL(msg) \</span>
<span class="cp">do { fprintf (stderr, &quot;FAIL: %s\n&quot;, msg); exit (-1); } while (0)</span>

<span class="cp">#define PIXELS_PER_POINT 1</span>

<span class="cp">#define PDF 0</span>
<span class="cp">#define PNG 1</span>

<span class="kt">int</span> <span class="nf">main</span> <span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
    <span class="n">GError</span> <span class="o">*</span><span class="n">error</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">RsvgHandle</span> <span class="o">*</span><span class="n">handle</span><span class="p">;</span>
    <span class="n">RsvgDimensionData</span> <span class="n">dim</span><span class="p">;</span>
    <span class="kt">double</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">;</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">filename</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">output_filename</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
    <span class="kt">cairo_surface_t</span> <span class="o">*</span><span class="n">surface</span><span class="p">;</span>
    <span class="kt">cairo_t</span> <span class="o">*</span><span class="n">cr</span><span class="p">;</span>
    <span class="kt">cairo_status_t</span> <span class="n">status</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">mode</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">FAIL</span> <span class="p">(</span><span class="s">&quot;usage: svgconvert input_file.svg output_file&quot;</span><span class="p">);</span>

    <span class="n">mode</span> <span class="o">=</span> <span class="n">PDF</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">g_str_has_suffix</span> <span class="p">(</span><span class="n">g_ascii_strdown</span> <span class="p">(</span><span class="n">output_filename</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="s">&quot;.png&quot;</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="n">PNG</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">g_type_init</span> <span class="p">();</span>

    <span class="n">rsvg_set_default_dpi</span> <span class="p">(</span><span class="mf">72.0</span><span class="p">);</span>
    <span class="n">handle</span> <span class="o">=</span> <span class="n">rsvg_handle_new_from_file</span> <span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">error</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
        <span class="n">FAIL</span> <span class="p">(</span><span class="n">error</span><span class="o">-&gt;</span><span class="n">message</span><span class="p">);</span>

    <span class="n">rsvg_handle_get_dimensions</span> <span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dim</span><span class="p">);</span>
    <span class="n">width</span> <span class="o">=</span> <span class="n">dim</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
    <span class="n">height</span> <span class="o">=</span> <span class="n">dim</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">PNG</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">surface</span> <span class="o">=</span> <span class="n">cairo_image_surface_create</span> <span class="p">(</span><span class="n">CAIRO_FORMAT_ARGB32</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="n">surface</span> <span class="o">=</span> <span class="n">cairo_pdf_surface_create</span> <span class="p">(</span><span class="n">output_filename</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">cr</span> <span class="o">=</span> <span class="n">cairo_create</span> <span class="p">(</span><span class="n">surface</span><span class="p">);</span>

    <span class="n">rsvg_handle_render_cairo</span> <span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">cr</span><span class="p">);</span>

    <span class="n">status</span> <span class="o">=</span> <span class="n">cairo_status</span> <span class="p">(</span><span class="n">cr</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
        <span class="n">FAIL</span> <span class="p">(</span><span class="n">cairo_status_to_string</span> <span class="p">(</span><span class="n">status</span><span class="p">));</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">PNG</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">cairo_surface_write_to_png</span> <span class="p">(</span><span class="n">surface</span><span class="p">,</span> <span class="n">output_filename</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">cairo_destroy</span> <span class="p">(</span><span class="n">cr</span><span class="p">);</span>
    <span class="n">cairo_surface_destroy</span> <span class="p">(</span><span class="n">surface</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="section" id="build-with-shared-librairies">
<h2>Build with shared librairies</h2>
<p>You would just do :</p>
<div class="highlight"><pre>gcc <span class="sb">`</span>pkg-config --cflags --libs librsvg-2.0 cairo-pdf<span class="sb">`</span> -o svgconvert svgconvert.c
</pre></div>
<p>which creates a binary of 9.0K.</p>
</div>
<div class="section" id="build-with-static-librairies">
<h2>Build with static librairies</h2>
<ul class="simple">
<li>First install the development versions of the packages, to make sure you have all <strong>/usr/lib/*.a</strong> mentioned below.</li>
<li>Use this Makefile, which creates a binary of 5.9M. It was tested on Ubuntu 8.04 which comes with Gnome 2.22, librsvg 2.22 and Cairo 1.6.0.</li>
</ul>
<div class="highlight"><pre><span class="nv">ALL</span><span class="o">=</span>svgconvert

<span class="nv">MYCFLAGS</span><span class="o">=</span><span class="sb">`</span>pkg-config --cflags librsvg-2.0 cairo-pdf<span class="sb">`</span>
<span class="nv">LDFLAGS</span><span class="o">=</span><span class="sb">`</span>pkg-config --libs librsvg-2.0 cairo-pdf freetype2 fontconfig pango pangoft2 pangocairo  cairo-ft libthai datrie libgsf-1 gnome-vfs-2.0 libcroco-0.6 libpcre pixman-1 libpng libxml-2.0<span class="sb">`</span>
<span class="nv">MYLDFLAGS</span><span class="o">=</span><span class="k">$(</span>LDFLAGS<span class="k">)</span> /usr/lib/libgio-2.0.a  /usr/lib/libglib-2.0.a /usr/lib/libselinux.a /usr/lib/libexpat.a /usr/lib/libfreetype.a /usr/lib/libbz2.a /usr/lib/libjpeg.a /usr/lib/libtiff.a /usr/lib/libbz2.a /usr/lib/libz.a /usr/lib/libm.a

all: <span class="k">$(</span>ALL<span class="k">)</span>

%: %.c
    <span class="k">$(</span>CC<span class="k">)</span> <span class="nv">$^</span> -pthread <span class="k">$(</span>MYCFLAGS<span class="k">)</span> -static <span class="k">$(</span>MYLDFLAGS<span class="k">)</span> -o <span class="nv">$@</span>

clean:
    rm -f <span class="k">$(</span>ALL<span class="k">)</span> *.o
</pre></div>
<ul class="simple">
<li>To check if <strong>pkg-config</strong> knows about a specific library :</li>
</ul>
<div class="highlight"><pre><span class="nv">$ </span>pkg-config --list-all <span class="p">|</span> grep vfs
gnome-vfs-sharp-2.0           GnomeVfs - GnomeVfs
gnome-vfs-2.0                 gnome-vfs - The GNOME virtual file-system libraries
gnome-vfsmm-2.6               gnome-vfsmm - C++ wrapper <span class="k">for</span> gnome-vfs
gnome-vfs-module-2.0          gnome-vfs-module - The GNOME virtual file-system module include info
</pre></div>
<ul class="simple">
<li>To check if a library has a specific symbol, use the <strong>nm</strong> command :</li>
</ul>
<div class="highlight"><pre><span class="nv">$ </span>nm /usr/lib/libexpat.a <span class="p">|</span> grep XML_SetStart
000001c0 T XML_SetStartCdataSectionHandler
<span class="m">00000240</span> T XML_SetStartDoctypeDeclHandler
<span class="m">00000150</span> T XML_SetStartElementHandler
000002a0 T XML_SetStartNamespaceDeclHandler
</pre></div>
</div>
<div class="section" id="download">
<h2>Download</h2>
<ul class="simple">
<li><a class="reference external" href="http://mathieu-leplatre.info/media/svgconvert-src.tar.gz">Source</a></li>
<li><a class="reference external" href="http://mathieu-leplatre.info/media/svgconvert-bin.tar.gz">Binary</a></li>
</ul>
</div>
<div class="section" id="references">
<h2>References</h2>
<ul class="simple">
<li><a class="reference external" href="http://cairographics.org">http://cairographics.org</a></li>
<li><a class="reference external" href="http://librsvg.sourceforge.net">http://librsvg.sourceforge.net</a></li>
<li>Thanks for the precious help of <a class="reference external" href="http://www.cworth.org">Carl Worth</a> on <cite>#cairo</cite> at irc.freenode.net, Zugzwang and nvteighen on <a class="reference external" href="http://ubuntuforums.org">http://ubuntuforums.org</a></li>
</ul>
</div>
<p>There are <a href="http://blog.mathieu-leplatre.info/static-build-of-cairo-and-librsvg.html#disqus_thread">comments</a>.</p>                </article>
<p class="paginator">
    Page 1 / 1
</p>
            </aside><!-- /#featured -->
            </ol><!-- /#posts-list -->
            </section><!-- /#content -->
        <section id="extras" class="body">
                <div class="social">
                        <h2>social</h2>
                        <ul>
                            <li><a href="http://blog.mathieu-leplatre.info/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>

                            <li><a href="http://www.linkedin.com/in/leplatre">LinkedIn</a></li>
                            <li><a href="https://code.launchpad.net/~mathieu.leplatre">Launchpad</a></li>
                            <li><a href="https://github.com/leplatrem">GitHub</a></li>
                            <li><a href="https://plus.google.com/u/0/106965745149150173373">Google+</a></li>
                            <li><a href="http://twitter.com/leplatrem">Twitter</a></li>
                            <li><a href="http://identi.ca/leplatrem">Identi.ca</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

    <script type="text/javascript">
        var pkBaseURL = (("https:" == document.location.protocol) ? "https://mathieu-leplatre.info/piwik/" : "http://mathieu-leplatre.info/piwik/");
    document.write(unescape("%3Cscript src='" + pkBaseURL + "piwik.js' type='text/javascript'%3E%3C/script%3E"));
    </script><script type="text/javascript">
    try {
    var piwikTracker = Piwik.getTracker(pkBaseURL + "piwik.php", 1);
    piwikTracker.trackPageView();
    piwikTracker.enableLinkTracking();
    } catch( err ) {}
    </script><noscript><p><img src="http://mathieu-leplatre.info/piwik/piwik.php?idsite=1" style="border:0" alt="" /></p></noscript>
<script type="text/javascript">
    var disqus_shortname = 'mathieuleplatre';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
</body>
</html>