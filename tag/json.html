<!DOCTYPE html>
<html lang="en">
<head>
        <title>Mathieu Leplatre - json</title>
        <meta charset="utf-8" />
        <link rel="stylesheet" href="http://blog.mathieu-leplatre.info/theme/css/main.css" type="text/css" />
        <link href="http://blog.mathieu-leplatre.info/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Mathieu Leplatre Atom Feed" />

        <!--[if IE]>
                <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

        <!--[if lte IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="http://blog.mathieu-leplatre.info/css/ie.css"/>
                <script src="http://blog.mathieu-leplatre.info/js/IE8.js" type="text/javascript"></script><![endif]-->

        <!--[if lt IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="http://blog.mathieu-leplatre.info/css/ie6.css"/><![endif]-->

</head>

<body id="index" class="home">
<a href="https://github.com/leplatrem">
<img style="position: absolute; top: 0; right: 0; border: 0;" src="http://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png" alt="Fork me on GitHub" />
</a>
        <header id="banner" class="body">
                <h1><a href="http://blog.mathieu-leplatre.info/">Mathieu Leplatre </a></h1>
                <nav><ul>
                    <li><a href="http://blog.mathieu-leplatre.info/pages/about.html">About</a></li>
                    <li ><a href="http://blog.mathieu-leplatre.info/category/dev.html">Dev</a></li>
                    <li ><a href="http://blog.mathieu-leplatre.info/category/personal.html">Personal</a></li>
                    <li ><a href="http://blog.mathieu-leplatre.info/category/sys.html">Sys</a></li>
                    <li ><a href="http://blog.mathieu-leplatre.info/category/ux.html">Ux</a></li>
                </ul></nav>
        </header><!-- /#banner -->
        
        

            <aside id="featured" class="body">
                <article>
                    <h1 class="entry-title"><a href="http://blog.mathieu-leplatre.info/access-a-json-webservice-with-qt-c.html">Access a JSON webservice with Qt C++</a></h1> 
<footer class="post-info">
        <abbr class="published" title="2011-12-16T17:00:00+01:00">
                Fri 16 December 2011
        </abbr>

        <address class="vcard author">
                By <a class="url fn" href="http://blog.mathieu-leplatre.info/author/mathieu-leplatre.html">Mathieu Leplatre</a>
        </address>
<p>In <a href="http://blog.mathieu-leplatre.info/category/dev.html">Dev</a>. </p>
<p>tags: <a href="http://blog.mathieu-leplatre.info/tag/c.html">c++</a><a href="http://blog.mathieu-leplatre.info/tag/qt.html">qt</a><a href="http://blog.mathieu-leplatre.info/tag/json.html">json</a></p>
</footer><!-- /.post-info --><p><em>Original post at</em> <a class="reference external" href="http://makina-corpus.org">Makina Corpus</a></p>
<p>Webservices are everywhere ! There are relevant in many situations, and
accessing them from your Qt C++ application is not an heresy.</p>
<p>I will present here a very simple way to retrieve a JSON from a GET request.</p>
<div class="section" id="http-requests">
<h2>HTTP Requests</h2>
<p>Using <a class="reference external" href="http://developer.qt.nokia.com/doc/qt-4.7/qnetworkaccessmanager.html">QNetworkAccessManager</a> is
a piece of cake :</p>
<div class="highlight"><pre><span class="n">QNetworkAccessManager</span> <span class="n">networkManager</span><span class="p">;</span>

<span class="n">QUrl</span> <span class="nf">url</span><span class="p">(</span><span class="s">&quot;http://gdata.youtube.com/feeds/api/standardfeeds/most_popular?v=2&amp;alt=json&quot;</span><span class="p">);</span>
<span class="n">QNetworkRequest</span> <span class="n">request</span><span class="p">;</span>
<span class="n">request</span><span class="p">.</span><span class="n">setUrl</span><span class="p">(</span><span class="n">url</span><span class="p">);</span>

<span class="n">QNetworkReply</span><span class="o">*</span> <span class="n">currentReply</span> <span class="o">=</span> <span class="n">networkManager</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>  <span class="c1">// GET</span>
</pre></div>
<p>But, note that a slightly more generic approach would be to build the <tt class="docutils literal">QUrl</tt> from a parameters list :</p>
<div class="highlight"><pre><span class="n">QUrl</span> <span class="nf">url</span><span class="p">(</span><span class="s">&quot;http://gdata.youtube.com/feeds/api/standardfeeds/&quot;</span><span class="p">);</span>
<span class="n">QString</span> <span class="n">method</span> <span class="o">=</span> <span class="s">&quot;most_popular&quot;</span><span class="p">;</span>
<span class="n">url</span><span class="p">.</span><span class="n">setPath</span><span class="p">(</span><span class="n">QString</span><span class="p">(</span><span class="s">&quot;%1%2&quot;</span><span class="p">).</span><span class="n">arg</span><span class="p">(</span><span class="n">url</span><span class="p">.</span><span class="n">path</span><span class="p">()).</span><span class="n">arg</span><span class="p">(</span><span class="n">method</span><span class="p">));</span>

<span class="n">QMap</span><span class="o">&lt;</span><span class="n">QString</span><span class="p">,</span> <span class="n">QVariant</span><span class="o">&gt;</span> <span class="n">params</span><span class="p">;</span>
<span class="n">params</span><span class="p">[</span><span class="s">&quot;alt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;json&quot;</span><span class="p">;</span>
<span class="n">params</span><span class="p">[</span><span class="s">&quot;v&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;2&quot;</span><span class="p">;</span>

<span class="n">foreach</span><span class="p">(</span><span class="n">QString</span> <span class="n">param</span><span class="p">,</span> <span class="n">params</span><span class="p">.</span><span class="n">keys</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">url</span><span class="p">.</span><span class="n">addQueryItem</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">params</span><span class="p">[</span><span class="n">param</span><span class="p">].</span><span class="n">toString</span><span class="p">());</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="section" id="parsing-json">
<h2>Parsing JSON</h2>
<p>Get yourself a <em>slot</em> to parse the <tt class="docutils literal">QNetworkReply</tt> :</p>
<div class="highlight"><pre><span class="n">connect</span><span class="p">(</span><span class="o">&amp;</span><span class="n">networkManager</span><span class="p">,</span> <span class="n">SIGNAL</span><span class="p">(</span><span class="n">finished</span><span class="p">(</span><span class="n">QNetworkReply</span><span class="o">*</span><span class="p">)),</span> <span class="k">this</span><span class="p">,</span> <span class="n">SLOT</span><span class="p">(</span><span class="n">onResult</span><span class="p">(</span><span class="n">QNetworkReply</span><span class="o">*</span><span class="p">)));</span>
</pre></div>
<div class="highlight"><pre><span class="kt">void</span> <span class="n">YourClass</span><span class="o">::</span><span class="n">onResult</span><span class="p">(</span><span class="n">QNetworkReply</span><span class="o">*</span> <span class="n">reply</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">m_currentReply</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">()</span> <span class="o">!=</span> <span class="n">QNetworkReply</span><span class="o">::</span><span class="n">NoError</span><span class="p">)</span>
        <span class="k">return</span><span class="p">;</span>  <span class="c1">// ...only in a blog post</span>

    <span class="n">QString</span> <span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">QString</span><span class="p">)</span> <span class="n">reply</span><span class="o">-&gt;</span><span class="n">readAll</span><span class="p">();</span>

    <span class="n">QScriptEngine</span> <span class="n">engine</span><span class="p">;</span>
    <span class="n">QScriptValue</span> <span class="n">result</span> <span class="o">=</span> <span class="n">engine</span><span class="p">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>

    <span class="cm">/*</span>
<span class="cm">      Google YouTube JSON looks like this :</span>

<span class="cm">      {</span>
<span class="cm">        &quot;version&quot;: &quot;1.0&quot;,</span>
<span class="cm">        &quot;encoding&quot;: &quot;UTF-8&quot;,</span>
<span class="cm">        &quot;feed&quot;: {</span>
<span class="cm">          ..</span>
<span class="cm">          ..</span>
<span class="cm">          &quot;entry&quot;: [{</span>
<span class="cm">            &quot;title&quot;: {</span>
<span class="cm">                &quot;$t&quot;: &quot;Nickelback- When We Stand Together&quot;</span>
<span class="cm">            },</span>
<span class="cm">            &quot;content&quot;: {</span>
<span class="cm">                &quot;type&quot;: &quot;application/x-shockwave-flash&quot;,</span>
<span class="cm">                &quot;src&quot;: &quot;http://www.youtube.com/v/76vdvdll0Y?version=3&amp;f=standard&amp;app=youtube_gdata&quot;</span>
<span class="cm">            },</span>
<span class="cm">            &quot;yt$statistics&quot;: {</span>
<span class="cm">                &quot;favoriteCount&quot;: &quot;29182&quot;,</span>
<span class="cm">                &quot;viewCount&quot;: &quot;41513706&quot;</span>
<span class="cm">            },</span>
<span class="cm">            ...</span>
<span class="cm">            ...</span>
<span class="cm">          },</span>
<span class="cm">          ...</span>
<span class="cm">          ...</span>
<span class="cm">          ]</span>
<span class="cm">        }</span>
<span class="cm">      }</span>
<span class="cm">    */</span>

    <span class="c1">// Now parse this JSON according to your needs !</span>
    <span class="n">QScriptValue</span> <span class="n">entries</span> <span class="o">=</span> <span class="n">result</span><span class="p">.</span><span class="n">property</span><span class="p">(</span><span class="s">&quot;feed&quot;</span><span class="p">).</span><span class="n">property</span><span class="p">(</span><span class="s">&quot;entry&quot;</span><span class="p">);</span>
    <span class="n">QScriptValueIterator</span> <span class="nf">it</span><span class="p">(</span><span class="n">entries</span><span class="p">);</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">it</span><span class="p">.</span><span class="n">hasNext</span><span class="p">())</span> <span class="p">{</span>
        <span class="n">it</span><span class="p">.</span><span class="n">next</span><span class="p">();</span>
        <span class="n">QScriptValue</span> <span class="n">entry</span> <span class="o">=</span> <span class="n">it</span><span class="p">.</span><span class="n">value</span><span class="p">();</span>

        <span class="n">QString</span> <span class="n">link</span> <span class="o">=</span> <span class="n">entry</span><span class="p">.</span><span class="n">property</span><span class="p">(</span><span class="s">&quot;content&quot;</span><span class="p">).</span><span class="n">property</span><span class="p">(</span><span class="s">&quot;src&quot;</span><span class="p">).</span><span class="n">toString</span><span class="p">();</span>
        <span class="kt">int</span> <span class="n">viewCount</span> <span class="o">=</span> <span class="n">entry</span><span class="p">.</span><span class="n">property</span><span class="p">(</span><span class="s">&quot;yt$statistics&quot;</span><span class="p">).</span><span class="n">property</span><span class="p">(</span><span class="s">&quot;viewCount&quot;</span><span class="p">).</span><span class="n">toInteger</span><span class="p">();</span>

        <span class="c1">// Do something with those...</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
<p>That's it :)</p>
<p>If you want more complexity, and don't mind adding extra-dependencies, check out Tomasz Siekierda's <a class="reference external" href="http://gitorious.org/qwebservice">QtWebService</a> !</p>
</div>
<p>There are <a href="http://blog.mathieu-leplatre.info/access-a-json-webservice-with-qt-c.html#disqus_thread">comments</a>.</p>                </article>
<p class="paginator">
    Page 1 / 1
</p>
            </aside><!-- /#featured -->
            </ol><!-- /#posts-list -->
            </section><!-- /#content -->
        <section id="extras" class="body">
                <div class="social">
                        <h2>social</h2>
                        <ul>
                            <li><a href="http://blog.mathieu-leplatre.info/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>

                            <li><a href="http://www.linkedin.com/in/leplatre">LinkedIn</a></li>
                            <li><a href="https://code.launchpad.net/~mathieu.leplatre">Launchpad</a></li>
                            <li><a href="https://github.com/leplatrem">GitHub</a></li>
                            <li><a href="https://plus.google.com/u/0/106965745149150173373">Google+</a></li>
                            <li><a href="http://twitter.com/leplatrem">Twitter</a></li>
                            <li><a href="http://identi.ca/leplatrem">Identi.ca</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

    <script type="text/javascript">
        var pkBaseURL = (("https:" == document.location.protocol) ? "https://mathieu-leplatre.info/piwik/" : "http://mathieu-leplatre.info/piwik/");
    document.write(unescape("%3Cscript src='" + pkBaseURL + "piwik.js' type='text/javascript'%3E%3C/script%3E"));
    </script><script type="text/javascript">
    try {
    var piwikTracker = Piwik.getTracker(pkBaseURL + "piwik.php", 1);
    piwikTracker.trackPageView();
    piwikTracker.enableLinkTracking();
    } catch( err ) {}
    </script><noscript><p><img src="http://mathieu-leplatre.info/piwik/piwik.php?idsite=1" style="border:0" alt="" /></p></noscript>
<script type="text/javascript">
    var disqus_shortname = 'mathieuleplatre';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
</body>
</html>