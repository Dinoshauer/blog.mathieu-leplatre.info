<!DOCTYPE html>
<html lang="en">
<head>
        <title>Mathieu Leplatre - virtualization</title>
        <meta charset="utf-8" />
        <link rel="stylesheet" href="http://blog.mathieu-leplatre.info/theme/css/main.css" type="text/css" />
        <link href="http://blog.mathieu-leplatre.info/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Mathieu Leplatre Atom Feed" />

        <!--[if IE]>
                <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

        <!--[if lte IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="http://blog.mathieu-leplatre.info/css/ie.css"/>
                <script src="http://blog.mathieu-leplatre.info/js/IE8.js" type="text/javascript"></script><![endif]-->

        <!--[if lt IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="http://blog.mathieu-leplatre.info/css/ie6.css"/><![endif]-->

</head>

<body id="index" class="home">
<a href="https://github.com/leplatrem">
<img style="position: absolute; top: 0; right: 0; border: 0;" src="http://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png" alt="Fork me on GitHub" />
</a>
        <header id="banner" class="body">
                <h1><a href="http://blog.mathieu-leplatre.info/">Mathieu Leplatre </a></h1>
                <nav><ul>
                    <li><a href="http://blog.mathieu-leplatre.info/pages/about.html">About</a></li>
                    <li ><a href="http://blog.mathieu-leplatre.info/category/dev.html">Dev</a></li>
                    <li ><a href="http://blog.mathieu-leplatre.info/category/personal.html">Personal</a></li>
                    <li ><a href="http://blog.mathieu-leplatre.info/category/sys.html">Sys</a></li>
                    <li ><a href="http://blog.mathieu-leplatre.info/category/ux.html">Ux</a></li>
                </ul></nav>
        </header><!-- /#banner -->
        
        

            <aside id="featured" class="body">
                <article>
                    <h1 class="entry-title"><a href="http://blog.mathieu-leplatre.info/a-virtual-local-server-room-for-you-developper.html">A Virtual Local Server Room for you Developper</a></h1> 
<footer class="post-info">
        <abbr class="published" title="2011-09-02T09:12:00+02:00">
                Fri 02 September 2011
        </abbr>

        <address class="vcard author">
                By <a class="url fn" href="http://blog.mathieu-leplatre.info/author/mathieu-leplatre-credits-anthony-prades.html">Mathieu Leplatre (credits: Anthony Prades)</a>
        </address>
<p>In <a href="http://blog.mathieu-leplatre.info/category/sys.html">Sys</a>. </p>
<p>tags: <a href="http://blog.mathieu-leplatre.info/tag/network.html">network</a><a href="http://blog.mathieu-leplatre.info/tag/kvm.html">kvm</a><a href="http://blog.mathieu-leplatre.info/tag/virtualization.html">virtualization</a><a href="http://blog.mathieu-leplatre.info/tag/howto.html">howto</a></p>
</footer><!-- /.post-info --><p>This how-to will help you setting-up a very powerful development environment
on your workstation, using virtual machines all in a virtual local network.</p>
<div class="section" id="but-why">
<h2>But Why ?</h2>
<p>You work on various projects, with specific requirements, with various
technologies, diverse operating systems or cpu architectures, usually with
a couple of services like databases or Web servers.</p>
<p>You would prefer not taking this whole family with you each time you start your machine.</p>
<p>Probably, you also want to upgrade your workstation to the last unstable eye-candy OS
without compromising your projects dependencies and without reinstalling all this stuff,
or you may want to restore the environment you had when you were working on this famous project a year ago.</p>
<p>You want your colleague to give you a hand, and would like to give him your
whole project environment and dependencies quickly and effortlessly ?
Your sysadmin put KVM on servers and you would like to push your local instances on
production in a blink ?</p>
<p>The magic medicine exists, and is freely available :)</p>
<p>At the end, you are promised to enjoy :</p>
<ul class="simple">
<li>a GUI to manage your Virtual Machines (VM)</li>
<li>a local domain to access your VMs by their name</li>
<li>a fully integrated set of machines, accessible from each others</li>
<li>movable and shareable virtual machines with automatic network configuration</li>
</ul>
<p>We chose the Linux Kernel-based Virtualization System (KVM), since it is maintained
along with the Linux kernel, and is thus fully integrated in the OS. However, this
how-to is mainly networking oriented and would be useful for any virtualization system.</p>
</div>
<div class="section" id="a-strict-minimum">
<h2>A Strict Minimum</h2>
<p>A strict minimum is to install <tt class="docutils literal">kvm</tt> and a set of commands to control it : <tt class="docutils literal">libvirt</tt>.
As a human being, you may want a GUI : <tt class="docutils literal"><span class="pre">virt-manager</span></tt>.</p>
<div class="highlight"><pre>sudo apt-get install kvm libvirt-bin virt-manager
</pre></div>
<div class="section" id="virtual-machines-network">
<h3>Virtual Machines Network</h3>
<p>Make sure your VM networking is set to <em>NAT</em>. This will allow
your VM to access your host network (LAN, Internet, etc.)</p>
<p>During your VM operating system installation, or after login into it,
setup your VM network interface as automatic DHCP.</p>
<p>By default KVM creates a virtual network (<tt class="docutils literal">virnet</tt>). Inspect its setup
using <tt class="docutils literal">ifconfig</tt> or <tt class="docutils literal"><span class="pre">virt-manager</span></tt> in <em>Connection Details</em> &gt; <em>Virtual Networks</em>.
Your VM and your host are thus accessible within this virtual network (probably <tt class="docutils literal">172.16.23.0</tt>).</p>
</div>
</div>
<div class="section" id="a-local-network-domain">
<h2>A Local Network Domain</h2>
<p>In order to access your VM by their name, we run a DNS daemon on main host. We chose <em>bind</em> :</p>
<div class="highlight"><pre>sudo aptitude install bind9
</pre></div>
<p>Add a new master zone, for example <tt class="docutils literal">sillywalk.loc</tt> in the file <tt class="docutils literal">/etc/bind/named.conf.local</tt> :</p>
<pre class="literal-block">
zone &quot;sillywalk.loc&quot; {
    type master;
    file &quot;/etc/bind/db.sillywalk.loc&quot;;
};
</pre>
<p>Define your DNS entries :</p>
<ul class="simple">
<li>Set the name server authority (<em>SOA</em>) to <tt class="docutils literal">ns.sillywalk.loc</tt> (<em>nameserver</em>)</li>
<li>Define a serial number like date+number (<tt class="docutils literal">YYYYmmdd##</tt>)</li>
<li>Associate <tt class="docutils literal">ns.sillywalk.loc</tt> to the IP of your KVM virtual network (<em>see above paragraph</em>)</li>
<li>Define an alias <cite>gw.sillywalk.loc</cite> so that you can refer to your host as <cite>gw</cite> (<em>gateway</em>) instead of <cite>ns</cite>.</li>
<li>Define a couple of entries for your VM (e.g. <tt class="docutils literal">myvm1</tt>, <tt class="docutils literal">myvm2</tt>)</li>
</ul>
<p>For <em>bind</em>, it would look like this <em>(started from an existing file like ``/etc/bind/db.empty``)</em> :</p>
<pre class="literal-block">
;/etc/bind/db.sillywalk.loc
;
; BIND data file for local loopback interface
;
$TTL    604800
&#64;   IN  SOA ns.sillywalk.loc. root.ns.sillywalk.loc. (
         2011080301     ; Serial
             604800     ; Refresh
              86400     ; Retry
            2419200     ; Expire
             604800 )   ; Negative Cache TTL
;
&#64;   IN  NS      ns.sillywalk.loc.
&#64;   IN  A       172.16.23.1
ns  IN  A       172.16.23.1
gw  IN  CNAME   ns.sillywalk.loc.

myvm1       IN  A   172.16.23.11
myvm2       IN  A   172.16.23.12
</pre>
<div class="section" id="use-your-dns">
<h3>Use your DNS</h3>
<p>Use your Network Manager to set the search domain to <tt class="docutils literal">sillywalk.loc</tt> and
to add your local DNS server (<tt class="docutils literal">127.0.0.1</tt>) in front of the other(s).</p>
<p>Apply and your <tt class="docutils literal">/etc/resolv.conf</tt> could then look like this :</p>
<pre class="literal-block">
# Generated by NetworkManager
search sillywalk.loc          # search domain
nameserver 127.0.0.1          # your local DNS server
nameserver 192.168.1.254      # your FAI/company DNS
nameserver 8.8.8.8            # Google public DNS
</pre>
</div>
<div class="section" id="test-it">
<h3>Test it !</h3>
<p>Even if your VM are not running, you can at least test the name resolving
and the default search domain :</p>
<div class="highlight"><pre>~<span class="nv">$ </span>ping myvm1.sillywalk.loc
PING myvm1.sillywalk.loc <span class="o">(</span>172.16.23.11<span class="o">)</span> 56<span class="o">(</span>84<span class="o">)</span> bytes of data.
<span class="c"># (Ctrl+C)</span>

~<span class="nv">$ </span>ping myvm2
PING myvm2.sillywalk.loc <span class="o">(</span>172.16.23.12<span class="o">)</span> 56<span class="o">(</span>84<span class="o">)</span> bytes of data.
<span class="c"># (Ctrl+C)</span>
</pre></div>
</div>
</div>
<div class="section" id="dynamic-configuration">
<h2>Dynamic Configuration</h2>
<p>In order to make sure your VM always obtains the same IP adress when it
boots, we setup a DHCP daemon on host.</p>
<p>We chose <em>ISC DHCP server</em> :</p>
<pre class="literal-block">
sudo aptitude install isc-dhcp-server
</pre>
<p>In the configuration file <tt class="docutils literal">/etc/dhcp/dhcpd.conf</tt>, we specify :</p>
<ul class="simple">
<li>a domain name (<tt class="docutils literal">sillywalk.loc</tt>)</li>
<li>the name server to be configured on clients (<tt class="docutils literal">ns.sillywalk.loc</tt>)</li>
<li>the subnet and mask (<em>matching the KVM virtual network</em>)</li>
<li>an IP range (e.g. from <tt class="docutils literal">172.16.23.10</tt> to <tt class="docutils literal">172.16.23.100</tt>)</li>
<li>the default gateway to be configured on clients (<tt class="docutils literal">ns.sillywalk.loc</tt>)</li>
<li>... and two entries for <tt class="docutils literal">myvm1</tt> and  <tt class="docutils literal">myvm2</tt> with their Mac addresses.</li>
</ul>
<pre class="literal-block">
# /etc/dhcp/dhcpd.conf

option domain-name &quot;sillywalk.loc&quot;;
option domain-name-servers ns.sillywalk.loc;

subnet 172.16.23.0 netmask 255.255.255.0 {
  range 172.16.23.10 172.16.23.100;
  option broadcast-address 172.16.23.255;
  option routers gw.sillywalk.loc;
}

# Entries

host myvm1 {
  hardware ethernet 52:54:00:55:d1:80;
  fixed-address myvm1.sillywalk.loc;
}

host myvm2 {
  hardware ethernet 52:54:00:55:e1:66;
  fixed-address myvm2.sillywalk.loc;
}
</pre>
<div class="section" id="id1">
<h3>Test it !</h3>
<p>Log you in on the VM.</p>
<ul class="simple">
<li>Configure its hostname (e.g. <tt class="docutils literal">myvm1</tt>, <tt class="docutils literal">myvm2</tt>)</li>
</ul>
<div class="highlight"><pre>root@myvm1:~# cat /etc/hostname
myvm1
root@myvm1:~# cat /etc/hosts
127.0.0.1   localhost
127.0.1.1   myvm1.sillywalk.loc myvm1
</pre></div>
<ul class="simple">
<li>Make sure your VM network is set to DHCP automatic configuration</li>
</ul>
<div class="highlight"><pre>root@myvm1:~# cat /etc/network/interfaces
...
<span class="c"># The primary network interface</span>
allow-hotplug eth0
iface eth0 inet dhcp
</pre></div>
<ul class="simple">
<li>Reboot it (or restart networking)</li>
<li>Check that it caught the right network configuration (IP, domain, and nameserver)</li>
</ul>
<div class="highlight"><pre>root@myvm1:~# ifconfig
eth0      Link encap:Ethernet  HWaddr 52:54:00:55:d1:80
          inet addr:172.16.23.11  Bcast:172.16.23.255  Mask:255.255.255.0
          ...
</pre></div>
<div class="highlight"><pre>root@myvm1:~# cat /etc/resolv.conf
domain sillywalk.loc
search sillywalk.loc
nameserver 172.16.23.1
</pre></div>
</div>
<div class="section" id="note">
<h3>Note</h3>
<p>While your host is booting, the DHCP daemon usually starts before the KVM service, failing
then at accessing the virtual network interface (<tt class="docutils literal">virbr1</tt>, <tt class="docutils literal">172.16.23.0</tt>), not yet mounted.</p>
<p>A simple solution is to manually restart your DHCP daemon, once your machine's booted :</p>
<div class="highlight"><pre>sudo /etc/init.d/isc-dhcp-server restart
</pre></div>
</div>
</div>
<div class="section" id="checklist-to-add-a-new-vm">
<h2>Checklist to add a new VM</h2>
<ul class="simple">
<li>Get its Mac address (with <tt class="docutils literal"><span class="pre">virt-manager</span></tt> : <em>Virtual machine details</em> &gt; <em>Virtual network interface</em> &gt; <em>Mac Address</em>)</li>
<li>Add it to your DHCP configuration (<tt class="docutils literal">/etc/dhcp/dhcpd.conf</tt>)</li>
<li>Add an IP for this entry in your DNS zone (<tt class="docutils literal">/etc/bind/db.sillywalk.loc</tt>) and increment the serial.</li>
<li>Restart DHCP service and reload DNS configuration</li>
</ul>
<div class="highlight"><pre>sudo /etc/init.d/isc-dhcp-server restart
sudo /etc/init.d/bind9 reload
</pre></div>
<p>If you do that all day, you'll quickly find it relevant to write a script...</p>
<div class="section" id="note-on-cloning">
<h3>Note on cloning</h3>
<p>Cloning your VM with <tt class="docutils literal"><span class="pre">virt-manager</span></tt> is a piece-of-cake.</p>
<p>However, during cloning, KVM assigns a new Mac address to the clone.
For debian-based virtual machines (+Ubuntu), log you in on the clone, and reinitialize network interfaces names :</p>
<div class="highlight"><pre>sudo rm /etc/udev/rules.d/70-persistent-net.rules
sudo reboot
</pre></div>
</div>
</div>
<div class="section" id="conclusion">
<h2>Conclusion</h2>
<p>Your virtual machines can :</p>
<ul class="simple">
<li>access your network (LAN, Internet) and your host (at <tt class="docutils literal">ns.sillywalk.loc</tt>)</li>
<li>be accessed at <tt class="docutils literal">user&#64;hostname</tt> (from host or from other VMs)</li>
<li>be moved to any host set up likewise (since VM networking is fully automatic)</li>
<li>be cloned easily</li>
</ul>
<p>Read again &quot;<a class="reference internal" href="#but-why">But Why ?</a>&quot; and enjoy your new life !</p>
</div>
<p>There are <a href="http://blog.mathieu-leplatre.info/a-virtual-local-server-room-for-you-developper.html#disqus_thread">comments</a>.</p>                </article>
<p class="paginator">
    Page 1 / 1
</p>
            </aside><!-- /#featured -->
            </ol><!-- /#posts-list -->
            </section><!-- /#content -->
        <section id="extras" class="body">
                <div class="social">
                        <h2>social</h2>
                        <ul>
                            <li><a href="http://blog.mathieu-leplatre.info/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>

                            <li><a href="http://www.linkedin.com/in/leplatre">LinkedIn</a></li>
                            <li><a href="https://code.launchpad.net/~mathieu.leplatre">Launchpad</a></li>
                            <li><a href="https://github.com/leplatrem">GitHub</a></li>
                            <li><a href="https://plus.google.com/u/0/106965745149150173373">Google+</a></li>
                            <li><a href="http://twitter.com/leplatrem">Twitter</a></li>
                            <li><a href="http://identi.ca/leplatrem">Identi.ca</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

    <script type="text/javascript">
        var pkBaseURL = (("https:" == document.location.protocol) ? "https://mathieu-leplatre.info/piwik/" : "http://mathieu-leplatre.info/piwik/");
    document.write(unescape("%3Cscript src='" + pkBaseURL + "piwik.js' type='text/javascript'%3E%3C/script%3E"));
    </script><script type="text/javascript">
    try {
    var piwikTracker = Piwik.getTracker(pkBaseURL + "piwik.php", 1);
    piwikTracker.trackPageView();
    piwikTracker.enableLinkTracking();
    } catch( err ) {}
    </script><noscript><p><img src="http://mathieu-leplatre.info/piwik/piwik.php?idsite=1" style="border:0" alt="" /></p></noscript>
<script type="text/javascript">
    var disqus_shortname = 'mathieuleplatre';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
</body>
</html>