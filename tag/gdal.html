<!DOCTYPE html>
<html lang="en">
<head>
        <title>Mathieu Leplatre - gdal</title>
        <meta charset="utf-8" />
        <link rel="stylesheet" href="http://blog.mathieu-leplatre.info/theme/css/main.css" type="text/css" />
        <link href="http://blog.mathieu-leplatre.info/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Mathieu Leplatre Atom Feed" />

        <!--[if IE]>
                <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

        <!--[if lte IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="http://blog.mathieu-leplatre.info/css/ie.css"/>
                <script src="http://blog.mathieu-leplatre.info/js/IE8.js" type="text/javascript"></script><![endif]-->

        <!--[if lt IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="http://blog.mathieu-leplatre.info/css/ie6.css"/><![endif]-->

</head>

<body id="index" class="home">
<a href="https://github.com/leplatrem">
<img style="position: absolute; top: 0; right: 0; border: 0;" src="http://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png" alt="Fork me on GitHub" />
</a>
        <header id="banner" class="body">
                <h1><a href="http://blog.mathieu-leplatre.info/">Mathieu Leplatre </a></h1>
                <nav><ul>
                    <li><a href="http://blog.mathieu-leplatre.info/pages/about.html">About</a></li>
                    <li ><a href="http://blog.mathieu-leplatre.info/category/dev.html">Dev</a></li>
                    <li ><a href="http://blog.mathieu-leplatre.info/category/personal.html">Personal</a></li>
                    <li ><a href="http://blog.mathieu-leplatre.info/category/sys.html">Sys</a></li>
                    <li ><a href="http://blog.mathieu-leplatre.info/category/ux.html">Ux</a></li>
                </ul></nav>
        </header><!-- /#banner -->
        
        

            <aside id="featured" class="body">
                <article>
                    <h1 class="entry-title"><a href="http://blog.mathieu-leplatre.info/postgis-data-in-c-using-gdal-and-qt.html">PostGIS data in C++ using GDAL and Qt</a></h1> 
<footer class="post-info">
        <abbr class="published" title="2011-08-23T10:25:00+02:00">
                Tue 23 August 2011
        </abbr>

        <address class="vcard author">
                By <a class="url fn" href="http://blog.mathieu-leplatre.info/author/mathieu-leplatre.html">Mathieu Leplatre</a>
        </address>
<p>In <a href="http://blog.mathieu-leplatre.info/category/dev.html">Dev</a>. </p>
<p>tags: <a href="http://blog.mathieu-leplatre.info/tag/c.html">c++</a><a href="http://blog.mathieu-leplatre.info/tag/qt.html">qt</a><a href="http://blog.mathieu-leplatre.info/tag/postgis.html">postgis</a><a href="http://blog.mathieu-leplatre.info/tag/gdal.html">gdal</a></p>
</footer><!-- /.post-info --><p><em>Original post at</em> <a class="reference external" href="http://makina-corpus.org">Makina Corpus</a></p>
<p>I did not find any ready-to-use snippets on the Web on this matter, so if
you are lucky enough, you'll find this one.</p>
<p>The objective is to read GIS geometries from a PostGIS database and manipulate
them in C++. I use Qt here, but it is not really a prerequisite, it just
helps a lot. Well, actually, it saves lives.</p>
<div class="section" id="database-connection">
<h2>Database Connection</h2>
<div class="highlight"><pre><span class="n">m_db</span> <span class="o">=</span> <span class="n">QSqlDatabase</span><span class="o">::</span><span class="n">addDatabase</span><span class="p">(</span><span class="s">&quot;QPSQL&quot;</span><span class="p">);</span>
<span class="n">m_db</span><span class="p">.</span><span class="n">setHostName</span><span class="p">(</span><span class="s">&quot;host&quot;</span><span class="p">);</span>
<span class="n">m_db</span><span class="p">.</span><span class="n">setDatabaseName</span><span class="p">(</span><span class="s">&quot;dbname&quot;</span><span class="p">);</span>
<span class="n">m_db</span><span class="p">.</span><span class="n">setUserName</span><span class="p">(</span><span class="s">&quot;user&quot;</span><span class="p">);</span>
<span class="n">m_db</span><span class="p">.</span><span class="n">setPassword</span><span class="p">(</span><span class="s">&quot;pass&quot;</span><span class="p">);</span>
</pre></div>
<p>Do not close the database at the end of each query.</p>
<div class="highlight"><pre><span class="n">m_db</span><span class="p">.</span><span class="n">close</span><span class="p">();</span>
<span class="n">m_db</span> <span class="o">=</span> <span class="n">QSqlDatabase</span><span class="p">();</span>  <span class="c1">// reinitialize for real</span>
</pre></div>
<p>Shut it down like this in your class' destructor or you may have errors like
<em>QSqlDatabasePrivate::removeDatabase: connection 'qt_sql_default_connection' is still in use, all queries will cease to work</em></p>
</div>
<div class="section" id="records-reading">
<h2>Records Reading</h2>
<div class="highlight"><pre><span class="n">QSqlQueryModel</span><span class="o">*</span> <span class="n">model</span> <span class="o">=</span> <span class="k">new</span> <span class="n">QSqlQueryModel</span><span class="p">();</span>

<span class="n">model</span><span class="o">-&gt;</span><span class="n">setQuery</span><span class="p">(</span><span class="s">&quot;SELECT id, ST_AsBinary(the_geom) AS the_geom &quot;</span>
                <span class="s">&quot;FROM table&quot;</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">numRows</span> <span class="o">=</span> <span class="n">model</span><span class="o">-&gt;</span><span class="n">rowCount</span><span class="p">();</span>

<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">numRows</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Read fields</span>
    <span class="n">qlonglong</span> <span class="n">id</span> <span class="o">=</span> <span class="n">record</span><span class="p">(</span><span class="n">i</span><span class="p">).</span><span class="n">value</span><span class="p">(</span><span class="s">&quot;id&quot;</span><span class="p">).</span><span class="n">toLongLong</span><span class="p">();</span>
    <span class="n">QByteArray</span> <span class="n">wkb</span> <span class="o">=</span> <span class="n">record</span><span class="p">(</span><span class="n">i</span><span class="p">).</span><span class="n">value</span><span class="p">(</span><span class="s">&quot;the_geom&quot;</span><span class="p">).</span><span class="n">toByteArray</span><span class="p">();</span>

    <span class="c1">// Process !</span>
    <span class="n">processRecord</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">wkb</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
<p>QByteArray uses <a class="reference external" href="http://doc.qt.nokia.com/latest/implicit-sharing.html">implicit sharing</a>
and can be passed as argument without being copied.</p>
</div>
<div class="section" id="geometries-parsing">
<h2>Geometries Parsing</h2>
<p>In this part, we rely on <a class="reference external" href="http://www.gdal.org">GDAL (Geospatial Data Abstraction Library)</a>
<a class="reference external" href="http://www.gdal.org/ogr/osr_tutorial.html">OGRSpatialReference</a>.</p>
<p>It provides an API to access geometries coordinates etc.</p>
<div class="highlight"><pre><span class="cp">#include &quot;ogrsf_frmts.h&quot; </span><span class="c1">// GDAL</span>
<span class="p">...</span>
<span class="p">...</span>

<span class="kt">void</span> <span class="n">Class</span><span class="o">::</span><span class="n">processRecord</span><span class="p">(</span><span class="n">qlonglong</span> <span class="n">id</span><span class="p">,</span> <span class="n">QByteArray</span> <span class="n">wkb</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">OGRSpatialReference</span> <span class="n">osr</span><span class="p">;</span>
    <span class="n">OGRGeometry</span> <span class="o">*</span><span class="n">geom</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="c1">// Parse WKB</span>
    <span class="n">OGRErr</span> <span class="n">err</span> <span class="o">=</span> <span class="n">OGRGeometryFactory</span><span class="o">::</span><span class="n">createFromWkb</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">wkb</span><span class="p">.</span><span class="n">constData</span><span class="p">(),</span> <span class="o">&amp;</span><span class="n">osr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">geom</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="n">OGRERR_NONE</span><span class="p">){</span>
        <span class="c1">// process error, like emit signal</span>
    <span class="p">}</span>

    <span class="c1">// Analyse geometry by type and process them as you wish</span>
    <span class="n">OGRwkbGeometryType</span> <span class="n">type</span> <span class="o">=</span> <span class="n">wkbFlatten</span><span class="p">(</span><span class="n">geom</span><span class="o">-&gt;</span><span class="n">getGeometryType</span><span class="p">());</span>
    <span class="k">switch</span><span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">case</span> <span class="nl">wkbLineString</span><span class="p">:</span> <span class="p">{</span>
            <span class="n">OGRLineString</span> <span class="o">*</span><span class="n">poRing</span> <span class="o">=</span> <span class="p">(</span><span class="n">OGRLineString</span><span class="o">*</span><span class="p">)</span><span class="n">geom</span><span class="p">;</span>

            <span class="c1">// Access line string nodes for example :</span>
            <span class="kt">int</span> <span class="n">numNode</span> <span class="o">=</span> <span class="n">poRing</span><span class="o">-&gt;</span><span class="n">getNumPoints</span><span class="p">();</span>
            <span class="n">OGRPoint</span> <span class="n">p</span><span class="p">;</span>
            <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="n">i</span> <span class="o">&lt;</span> <span class="n">numNode</span><span class="p">;</span>  <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">poRing</span><span class="o">-&gt;</span><span class="n">getPoint</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="p">);</span>
                <span class="n">qDebug</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">p</span><span class="p">.</span><span class="n">getX</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">p</span><span class="p">.</span><span class="n">getY</span><span class="p">();</span>
            <span class="p">}</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">case</span> <span class="nl">wkbMultiLineString</span><span class="p">:</span>
        <span class="p">{</span>
            <span class="n">OGRGeometryCollection</span>  <span class="o">*</span><span class="n">poCol</span> <span class="o">=</span> <span class="p">(</span><span class="n">OGRGeometryCollection</span><span class="o">*</span><span class="p">)</span> <span class="n">geom</span><span class="p">;</span>
            <span class="kt">int</span> <span class="n">numCol</span> <span class="o">=</span> <span class="n">poCol</span><span class="o">-&gt;</span><span class="n">getNumGeometries</span><span class="p">();</span>
            <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">numCol</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                <span class="c1">// Access line length for example :</span>
                <span class="n">qDebug</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">poCol</span><span class="o">-&gt;</span><span class="n">getGeometryRef</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">get_Length</span><span class="p">();</span>
            <span class="p">}</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">default</span><span class="o">:</span>
            <span class="c1">// process error, like emit signal</span>
    <span class="p">}</span>

    <span class="c1">// Clean-up</span>
    <span class="n">OGRGeometryFactory</span><span class="o">::</span><span class="n">destroyGeometry</span><span class="p">(</span><span class="n">geom</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
<p>In this snippet, I only process linestrings, but all <a class="reference external" href="http://www.gdal.org/ogr/ogr__core_8h.html#800236a0d460ef66e687b7b65610f12a">geometry types are available</a>.
Consider writing a recursive function for geometry collections and so forth...</p>
<p>Hope this helped !</p>
</div>
<p>There are <a href="http://blog.mathieu-leplatre.info/postgis-data-in-c-using-gdal-and-qt.html#disqus_thread">comments</a>.</p>                </article>
<p class="paginator">
    Page 1 / 1
</p>
            </aside><!-- /#featured -->
            </ol><!-- /#posts-list -->
            </section><!-- /#content -->
        <section id="extras" class="body">
                <div class="social">
                        <h2>social</h2>
                        <ul>
                            <li><a href="http://blog.mathieu-leplatre.info/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>

                            <li><a href="http://www.linkedin.com/in/leplatre">LinkedIn</a></li>
                            <li><a href="https://code.launchpad.net/~mathieu.leplatre">Launchpad</a></li>
                            <li><a href="https://github.com/leplatrem">GitHub</a></li>
                            <li><a href="https://plus.google.com/u/0/106965745149150173373">Google+</a></li>
                            <li><a href="http://twitter.com/leplatrem">Twitter</a></li>
                            <li><a href="http://identi.ca/leplatrem">Identi.ca</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

    <script type="text/javascript">
        var pkBaseURL = (("https:" == document.location.protocol) ? "https://mathieu-leplatre.info/piwik/" : "http://mathieu-leplatre.info/piwik/");
    document.write(unescape("%3Cscript src='" + pkBaseURL + "piwik.js' type='text/javascript'%3E%3C/script%3E"));
    </script><script type="text/javascript">
    try {
    var piwikTracker = Piwik.getTracker(pkBaseURL + "piwik.php", 1);
    piwikTracker.trackPageView();
    piwikTracker.enableLinkTracking();
    } catch( err ) {}
    </script><noscript><p><img src="http://mathieu-leplatre.info/piwik/piwik.php?idsite=1" style="border:0" alt="" /></p></noscript>
<script type="text/javascript">
    var disqus_shortname = 'mathieuleplatre';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
</body>
</html>